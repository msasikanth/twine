import kotlin.Boolean;
import kotlin.time.Instant;

CREATE TABLE IF NOT EXISTS feedGroup(
  id TEXT NOT NULL PRIMARY KEY,
  name TEXT NOT NULL,
  createdAt INTEGER AS Instant NOT NULL,
  updatedAt INTEGER AS Instant NOT NULL,
  pinnedAt INTEGER AS Instant,
  pinnedPosition REAL NOT NULL DEFAULT 0.0,
  isDeleted INTEGER AS Boolean NOT NULL DEFAULT 0,
  remoteId TEXT
);

CREATE INDEX feed_group_pinned_at ON feedGroup(pinnedAt);
CREATE INDEX feed_group_pinned_position ON feedGroup(pinnedPosition);
CREATE INDEX feed_group_pinned_name ON feedGroup(pinnedAt DESC, name);
CREATE INDEX feed_group_remoteId_index ON feedGroup(remoteId) WHERE remoteId IS NOT NULL;
CREATE INDEX feed_group_isDeleted_index ON feedGroup(isDeleted);

count:
SELECT COUNT(*) FROM feedGroup WHERE isDeleted = 0;

groups:
SELECT
  id,
  name,
  (SELECT GROUP_CONCAT(gf.feedId, '::')
       FROM feedGroupFeed gf
       JOIN feed f ON gf.feedId = f.id
       WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0) AS feedIds,
  COALESCE((SELECT GROUP_CONCAT(f.homepageLink, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedHomepageLinks,
  COALESCE((SELECT GROUP_CONCAT(f.icon, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedIconLinks,
  COALESCE((SELECT GROUP_CONCAT(CASE WHEN f.showFeedFavIcon IS NULL THEN 'null' WHEN f.showFeedFavIcon = 1 THEN 'true' ELSE 'false' END, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedShowFavIconSettings,
  createdAt,
  updatedAt,
  pinnedAt,
  pinnedPosition,
  remoteId
FROM feedGroup fg
WHERE isDeleted = 0
GROUP BY fg.id
LIMIT :limit OFFSET :offset;

groupsBlocking:
SELECT
  id,
  name,
  (SELECT GROUP_CONCAT(gf.feedId, '::')
       FROM feedGroupFeed gf
       JOIN feed f ON gf.feedId = f.id
       WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0) AS feedIds,
  COALESCE((SELECT GROUP_CONCAT(f.homepageLink, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedHomepageLinks,
  COALESCE((SELECT GROUP_CONCAT(f.icon, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedIconLinks,
  COALESCE((SELECT GROUP_CONCAT(CASE WHEN f.showFeedFavIcon IS NULL THEN 'null' WHEN f.showFeedFavIcon = 1 THEN 'true' ELSE 'false' END, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedShowFavIconSettings,
  createdAt,
  updatedAt,
  pinnedAt,
  pinnedPosition,
  remoteId
FROM feedGroup fg
WHERE isDeleted = 0
GROUP BY fg.id;

createGroup:
INSERT INTO feedGroup(id, name, createdAt, updatedAt)
VALUES (:id, :name, :createdAt, :updatedAt)
ON CONFLICT(id) DO UPDATE SET
  name = excluded.name,
  updatedAt = excluded.updatedAt,
  isDeleted = 0;

updateGroupName:
UPDATE feedGroup SET name = :name, updatedAt = :updatedAt WHERE id = :id;

updateUpdatedAt:
UPDATE feedGroup SET updatedAt = :updatedAt WHERE id = :id;

markAsDeleted:
UPDATE feedGroup SET isDeleted = 1, updatedAt = :updatedAt WHERE id = :id;

remove:
DELETE FROM feedGroup WHERE id = :id;

updatePinnedAt:
UPDATE feedGroup SET pinnedAt = :pinnedAt, pinnedPosition = 0.0, updatedAt = :updatedAt WHERE id = :id;

group:
SELECT
  id,
  name,
  (SELECT GROUP_CONCAT(gf.feedId, '::')
       FROM feedGroupFeed gf
       JOIN feed f ON gf.feedId = f.id
       WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0) AS feedIds,
  COALESCE((SELECT GROUP_CONCAT(f.homepageLink, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedHomepageLinks,
  COALESCE((SELECT GROUP_CONCAT(f.icon, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedIconLinks,
  COALESCE((SELECT GROUP_CONCAT(CASE WHEN f.showFeedFavIcon IS NULL THEN 'null' WHEN f.showFeedFavIcon = 1 THEN 'true' ELSE 'false' END, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedShowFavIconSettings,
  createdAt,
  updatedAt,
  pinnedAt,
  pinnedPosition,
  isDeleted,
  remoteId
FROM feedGroup fg
WHERE id = :id AND isDeleted = 0;

groupsByIds:
SELECT
  id,
  name,
  (SELECT GROUP_CONCAT(gf.feedId, '::')
       FROM feedGroupFeed gf
       JOIN feed f ON gf.feedId = f.id
       WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0) AS feedIds,
  COALESCE((SELECT GROUP_CONCAT(f.homepageLink, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedHomepageLinks,
  COALESCE((SELECT GROUP_CONCAT(f.icon, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedIconLinks,
  COALESCE((SELECT GROUP_CONCAT(CASE WHEN f.showFeedFavIcon IS NULL THEN 'null' WHEN f.showFeedFavIcon = 1 THEN 'true' ELSE 'false' END, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedShowFavIconSettings,
  createdAt,
  updatedAt,
  pinnedAt,
  remoteId
FROM feedGroup fg
WHERE id IN :ids AND isDeleted = 0
GROUP BY fg.id;

updatedPinnedPosition:
UPDATE feedGroup SET pinnedPosition = :pinnedPosition, updatedAt = :updatedAt WHERE id = :id;

allGroupsBlocking:
SELECT
  id,
  name,
  (SELECT GROUP_CONCAT(gf.feedId, '::')
       FROM feedGroupFeed gf
       JOIN feed f ON gf.feedId = f.id
       WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0) AS feedIds,
  COALESCE((SELECT GROUP_CONCAT(f.homepageLink, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedHomepageLinks,
  COALESCE((SELECT GROUP_CONCAT(f.icon, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedIconLinks,
  COALESCE((SELECT GROUP_CONCAT(CASE WHEN f.showFeedFavIcon IS NULL THEN 'null' WHEN f.showFeedFavIcon = 1 THEN 'true' ELSE 'false' END, '::')
     FROM feedGroupFeed gf
     JOIN feed f ON gf.feedId = f.id
     WHERE gf.feedGroupId = fg.id AND f.isDeleted = 0
     LIMIT 4), '') AS feedShowFavIconSettings,
  createdAt,
  updatedAt,
  pinnedAt,
  pinnedPosition,
  isDeleted,
  remoteId
FROM feedGroup fg;

deleteAll:
DELETE FROM feedGroup;

upsertSyncGroup:
INSERT INTO feedGroup(id, name, createdAt, updatedAt, pinnedAt, isDeleted, remoteId)
VALUES (:id, :name, :createdAt, :updatedAt, :pinnedAt, :isDeleted, :remoteId)
ON CONFLICT(id) DO
UPDATE SET
    name = excluded.name,
    pinnedAt = excluded.pinnedAt,
    updatedAt = excluded.updatedAt,
    isDeleted = excluded.isDeleted,
    remoteId = excluded.remoteId
WHERE excluded.updatedAt > feedGroup.updatedAt OR feedGroup.updatedAt IS NULL;

updateFeedGroupRemoteId:
UPDATE feedGroup SET remoteId = :remoteId, updatedAt = :updatedAt WHERE id = :id;

feedGroupByRemoteId:
SELECT * FROM feedGroup WHERE remoteId = :remoteId AND isDeleted = 0;
